
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      String   @default("STUDENT") // STUDENT, STAFF, ADMIN
  createdAt DateTime @default(now())

  // Security & OTP
  isVerified       Boolean   @default(false)
  otpHash          String?
  otpExpiresAt     DateTime?
  otpLastSentAt    DateTime? // For rate limiting cooldown
  otpSendCount     Int       @default(0) // Track 3 per 10 mins
  otpResetAt       DateTime? // When to reset the count
  otpAttempts      Int       @default(0) // Track failed attempts
  lockedUntil      DateTime? // Account lock after 3 failed attempts

  notes     Note[]
  progress  LearningMetric[]
  doubts    Doubt[]
  
  // LMS Relations
  courses     Course[]     @relation("TeacherCourses")
  enrollments Enrollment[]
  submissions Submission[]
  attempts    Attempt[]
}

model Note {
  id        String   @id @default(uuid())
  title     String
  content   String
  subject   String   @default("General")
  summary   String?
  fileUrl   String?
  fileType  String?  // PDF, IMAGE, DOCX, VIDEO, YOUTUBE
  youtubeId String?  // Stores YouTube Video ID for embedding
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  courseId  String?
  course    Course?   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  heatmap   HeatmapPoint[]
}

model HeatmapPoint {
  id        String   @id @default(uuid())
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  yPosition Float    // Percentage (0.0 to 1.0) of scroll height
  createdAt DateTime @default(now())
}

model Doubt {
  id        String   @id @default(uuid())
  content   String
  highlight String?  // The text selected
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

model LearningMetric {
  id        String   @id @default(uuid())
  topic     String
  score     Int      @default(0) // 0-100 mastery
  userId    String
  user      User     @relation(fields: [userId], references: [id])
}

// --- LMS MODELS ---

model Course {
  id          String   @id @default(uuid())
  name        String
  section     String?
  description String?
  code        String   @unique // 6-char code for joining
  bannerImg   String?
  createdAt   DateTime @default(now())
  
  teacherId   String
  teacher     User     @relation("TeacherCourses", fields: [teacherId], references: [id])
  
  enrollments Enrollment[]
  assignments Assignment[]
  quizzes     Quiz[]
  notes       Note[]
}

model Enrollment {
  id        String   @id @default(uuid())
  joinedAt  DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime?
  points      Int      @default(100)
  createdAt   DateTime @default(now())
  
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  submissions Submission[]
}

model Submission {
  id           String   @id @default(uuid())
  submittedAt  DateTime @default(now())
  content      String?  // Text submission
  fileUrl      String?  // File attachment
  grade        Int?     // Null = not graded
  feedback     String?
  
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  
  studentId    String
  student      User       @relation(fields: [studentId], references: [id])
}

// --- EXAM & AI PROCTORING MODELS ---

model Quiz {
  id          String   @id @default(uuid())
  title       String
  topic       String?
  difficulty  String   @default("Medium") // Easy, Medium, Hard
  isAI        Boolean  @default(false)    // Generated by AI?
  createdAt   DateTime @default(now())
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  questions   Question[]
  attempts    Attempt[]
}

model Question {
  id            String   @id @default(uuid())
  text          String
  type          String   @default("MCQ") // MCQ, SHORT_ANSWER
  options       String   // JSON string of options ["A", "B", "C", "D"]
  correctOption Int      // Index of correct option (0-3) or null for subjective
  explanation   String?
  
  quizId        String
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model Attempt {
  id          String   @id @default(uuid())
  score       Int
  startedAt   DateTime @default(now())
  completedAt DateTime @default(now())
  violations  String?  // JSON string of proctoring logs (tab switches, etc)
  
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     User     @relation(fields: [studentId], references: [id])
}
